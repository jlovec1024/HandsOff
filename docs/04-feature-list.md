# 功能清单

## 1. 功能模块总览

基于25项需求，系统划分为以下8大功能模块：

```
AI代码审查系统
├── 1. 认证与权限管理
├── 2. Git平台管理
├── 3. 代码仓库管理
├── 4. 仓库组管理
├── 5. LLM配置管理
├── 6. 通知渠道管理
├── 7. Review记录管理
└── 8. 自动修复管理
```

---

## 2. 详细功能清单

### 模块1: 认证与权限管理

| 功能ID | 功能名称 | 功能描述 | 优先级 |
|--------|---------|---------|--------|
| AUTH-001 | 用户登录 | JWT Token认证登录 | P0 |
| AUTH-002 | 用户退出 | 清除Token，退出登录 | P0 |
| AUTH-003 | Token刷新 | 刷新过期Token | P1 |
| AUTH-004 | 用户管理 | 管理员创建/编辑/删除用户 | P1 |
| AUTH-005 | 角色管理 | admin/user角色权限控制 | P2 |

---

### 模块2: Git平台管理 (需求1-3)

#### 2.1 平台配置管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| PLT-001 | 添加平台配置 | 配置GitLab/GitHub/Gitea认证 | 需求1 | P0 |
| PLT-002 | 编辑平台配置 | 修改平台信息、Token等 | 需求1 | P0 |
| PLT-003 | 删除平台配置 | 删除不再使用的平台 | 需求1 | P0 |
| PLT-004 | 查看平台列表 | 分页展示所有平台配置 | 需求1 | P0 |
| PLT-005 | 测试平台连接 | 验证Token有效性 | 需求1 | P0 |
| PLT-006 | 启用/禁用平台 | 快速开关平台 | 需求1 | P1 |
| PLT-007 | 支持多GitLab实例 | 同时对接多个GitLab | 需求1 | P0 |

**技术实现:**
- Token加密存储 (AES-256)
- 平台API适配层 (gitlab/github/gitea)
- 连接测试 (调用API获取用户信息)

---

### 模块3: 代码仓库管理 (需求2-3)

#### 3.1 仓库导入

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| REPO-001 | 从平台获取仓库列表 | 分页获取Git平台的仓库 | 需求2 | P0 |
| REPO-002 | 搜索仓库 | 按名称搜索仓库 | 需求2 | P0 |
| REPO-003 | 批量导入仓库 | 勾选多个仓库批量导入 | 需求2 | P0 |
| REPO-004 | 单个导入仓库 | 导入单个仓库 | 需求2 | P0 |

#### 3.2 Webhook管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| REPO-005 | 自动配置Webhook | 为仓库自动创建Webhook | 需求2 | P0 |
| REPO-006 | 自定义Webhook URL | 配置自定义回调地址 | 需求3 | P0 |
| REPO-007 | 测试Webhook | 发送测试请求 | 需求2 | P1 |
| REPO-008 | 删除Webhook | 移除Webhook配置 | 需求2 | P0 |
| REPO-009 | 查看Webhook状态 | 显示是否已配置 | 需求2 | P0 |
| REPO-010 | 批量配置Webhook | 批量为多个仓库配置 | 需求2 | P1 |

#### 3.3 仓库管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| REPO-011 | 查看仓库列表 | 展示已导入的仓库 | 需求2 | P0 |
| REPO-012 | 编辑仓库信息 | 修改默认分支等 | 需求2 | P1 |
| REPO-013 | 删除仓库 | 移除仓库 | 需求2 | P0 |
| REPO-014 | 同步仓库信息 | 从平台同步最新信息 | 需求2 | P1 |

**技术实现:**
- GitLab API: `POST /api/v4/projects/:id/hooks`
- GitHub API: `POST /repos/:owner/:repo/hooks`
- Gitea API: `POST /api/v1/repos/:owner/:repo/hooks`

---

### 模块4: 仓库组管理 (需求4-6, 13)

#### 4.1 仓库组基础管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| GRP-001 | 创建仓库组 | 新建仓库组 | 需求4 | P0 |
| GRP-002 | 编辑仓库组 | 修改名称、描述 | 需求4 | P0 |
| GRP-003 | 删除仓库组 | 删除仓库组 | 需求4 | P0 |
| GRP-004 | 查看仓库组列表 | 展示所有仓库组 | 需求4 | P0 |

#### 4.2 仓库关联管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| GRP-005 | 添加仓库到组 | 将仓库加入组 | 需求4 | P0 |
| GRP-006 | 从组移除仓库 | 从组中移除仓库 | 需求4 | P0 |
| GRP-007 | 批量添加仓库 | 批量关联仓库 | 需求4 | P1 |
| GRP-008 | 查看组内仓库 | 展示组内所有仓库 | 需求4 | P0 |

#### 4.3 通知渠道配置

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| GRP-009 | 配置通知渠道 | 为组配置通知渠道 | 需求5 | P0 |
| GRP-010 | 移除通知渠道 | 移除通知渠道 | 需求5 | P0 |
| GRP-011 | 批量配置渠道 | 批量配置多个渠道 | 需求5 | P1 |

#### 4.4 LLM模型配置

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| GRP-012 | 配置专属LLM | 为组指定LLM模型 | 需求6 | P0 |
| GRP-013 | 修改LLM配置 | 更换LLM模型 | 需求6 | P0 |
| GRP-014 | 使用默认LLM | 不配置则使用全局默认 | 需求6 | P1 |

#### 4.5 提示词模板管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| GRP-015 | 自定义提示词 | 编辑system/user prompt | 需求13 | P0 |
| GRP-016 | 预览提示词 | 预览渲染后的提示词 | 需求13 | P1 |
| GRP-017 | 重置为默认 | 恢复默认提示词模板 | 需求13 | P1 |
| GRP-018 | 支持模板变量 | {{diffs}}, {{commits}}等 | 需求13 | P0 |

**提示词模板格式:**
```yaml
system_prompt: |
  你是一个资深的{{language}}代码审查专家...
  
user_prompt: |
  请审查以下代码变更:
  {{diffs_text}}
  
  提交信息:
  {{commits_text}}
```

---

### 模块5: LLM配置管理 (需求9-12)

#### 5.1 LLM供应商管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| LLM-001 | 添加LLM供应商 | 配置DeepSeek/OpenAI等 | 需求9 | P0 |
| LLM-002 | 编辑LLM供应商 | 修改API Key等 | 需求9 | P0 |
| LLM-003 | 删除LLM供应商 | 删除供应商配置 | 需求9 | P0 |
| LLM-004 | 查看供应商列表 | 展示所有供应商 | 需求9 | P0 |
| LLM-005 | 测试LLM连接 | 发送测试请求 | 需求10 | P0 |
| LLM-006 | 启用/禁用供应商 | 快速开关 | 需求9 | P1 |

**支持的LLM供应商:**
- DeepSeek
- OpenAI
- ZhipuAI (智谱AI)
- Qwen (通义千问)
- Ollama (本地部署)

#### 5.2 LLM模型管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| LLM-007 | 手动添加模型 | 手动配置模型 | 需求11 | P0 |
| LLM-008 | 编辑模型配置 | 修改max_tokens等 | 需求11 | P0 |
| LLM-009 | 删除模型 | 删除模型配置 | 需求11 | P0 |
| LLM-010 | 查看模型列表 | 展示供应商下的模型 | 需求11 | P0 |
| LLM-011 | 动态获取模型列表 | 从API获取可用模型 | 需求12 | P0 |
| LLM-012 | 批量导入模型 | 批量导入API返回的模型 | 需求12 | P1 |
| LLM-013 | 启用/禁用模型 | 控制模型可用性 | 需求11 | P1 |

**动态获取模型实现 (需求12):**
```
OpenAI: GET /v1/models
DeepSeek: GET /models (兼容OpenAI API)
Ollama: GET /api/tags
ZhipuAI: 需要自定义实现
Qwen: 需要自定义实现
```

---

### 模块6: 通知渠道管理 (需求7-8, 21)

#### 6.1 通知渠道基础管理

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| NOTIF-001 | 添加通知渠道 | 配置钉钉/企微/飞书 | 需求7 | P0 |
| NOTIF-002 | 编辑通知渠道 | 修改Webhook URL等 | 需求7 | P0 |
| NOTIF-003 | 删除通知渠道 | 删除渠道配置 | 需求7 | P0 |
| NOTIF-004 | 查看渠道列表 | 展示所有通知渠道 | 需求7 | P0 |
| NOTIF-005 | 测试通知渠道 | 发送测试消息 | 需求8 | P0 |
| NOTIF-006 | 启用/禁用渠道 | 快速开关 | 需求7 | P1 |

**支持的通知渠道:**
- 钉钉 (DingTalk)
- 企业微信 (WeCom)
- 飞书 (Feishu)
- 自定义Webhook

#### 6.2 通知内容配置

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| NOTIF-007 | 配置通知内容 | 选择展示哪些信息 | 需求21 | P0 |
| NOTIF-008 | 是否展示Commit | 配置是否显示commit信息 | 需求21 | P0 |
| NOTIF-009 | 是否展示评分 | 配置是否显示分数 | 需求21 | P0 |
| NOTIF-010 | 是否展示建议 | 配置是否显示修复建议 | 需求21 | P1 |
| NOTIF-011 | 自定义模板 | 自定义消息模板 | 需求21 | P2 |

**通知内容配置示例:**
```json
{
  "show_commits": true,
  "show_score": true,
  "show_suggestions": true,
  "show_diff_stats": true
}
```

---

### 模块7: Review记录管理 (需求14-15)

#### 7.1 Review记录查询

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| REV-001 | 查看Review列表 | 分页展示Review记录 | - | P0 |
| REV-002 | 按仓库筛选 | 筛选特定仓库的Review | - | P0 |
| REV-003 | 按时间筛选 | 按日期范围筛选 | - | P0 |
| REV-004 | 按作者筛选 | 筛选特定作者的Review | - | P1 |
| REV-005 | 按评分筛选 | 筛选特定分数范围 | - | P1 |
| REV-006 | 搜索Review | 关键词搜索 | - | P1 |

#### 7.2 Review详情查看

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| REV-007 | 查看原始结果 | 展示AI返回的原始文本 | 需求14 | P0 |
| REV-008 | 查看结构化结果 | 展示解析后的JSON数据 | 需求14 | P0 |
| REV-009 | 查看总体评分 | 显示分数 | 需求14 | P0 |
| REV-010 | 查看总结 | 显示Review总结 | 需求14 | P0 |
| REV-011 | 查看修复建议列表 | 展示所有建议 | 需求15 | P0 |
| REV-012 | 查看代码差异 | Diff对比展示 | - | P0 |
| REV-013 | 查看Commit信息 | 展示相关commits | - | P1 |

#### 7.3 修复建议展示

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| REV-014 | 按文件分组展示 | 按文件路径分组 | 需求15 | P0 |
| REV-015 | 按严重程度排序 | critical > high > medium > low | 需求15 | P0 |
| REV-016 | 显示问题类型 | performance/security/style/logic | 需求15 | P0 |
| REV-017 | 显示代码片段 | 展示相关代码 | 需求15 | P0 |
| REV-018 | 显示行号范围 | 显示问题所在行 | 需求15 | P0 |
| REV-019 | 显示修复建议 | 展示具体建议 | 需求15 | P0 |

**结构化Review结果格式:**
```json
{
  "overall_score": 85,
  "summary": "代码整体质量良好",
  "suggestions": [
    {
      "file_path": "src/utils/helper.go",
      "line_start": 10,
      "line_end": 15,
      "issue_type": "performance",
      "severity": "medium",
      "description": "循环中存在重复计算",
      "suggestion": "建议将计算结果缓存",
      "code_snippet": "..."
    }
  ]
}
```

---

### 模块8: 自动修复管理 (需求16-25)

#### 8.1 触发自动修复 (需求16-17)

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| FIX-001 | 触发自动修复 | 点击按钮触发修复 | 需求16 | P0 |
| FIX-002 | 克隆仓库 | Clone代码到本地 | 需求17 | P0 |
| FIX-003 | 创建修复分支 | 基于base branch创建 | 需求17 | P0 |
| FIX-004 | 执行Snow-CLI | 调用AI修复工具 | 需求17 | P0 |
| FIX-005 | 提交修复代码 | Git commit | 需求17 | P0 |
| FIX-006 | 推送修复分支 | Git push | 需求17 | P0 |
| FIX-007 | 清理工作目录 | 删除临时文件 | 需求17 | P1 |

**修复流程:**
```
触发修复 → Clone仓库 → 创建分支 → AI修复 → Commit → Push → 清理
```

#### 8.2 进度与日志 (需求18)

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| FIX-008 | 查看修复进度 | 显示任务状态 | 需求18 | P0 |
| FIX-009 | 实时日志流 | WebSocket推送日志 | 需求18 | P0 |
| FIX-010 | 日志分级显示 | info/warning/error/debug | 需求18 | P0 |
| FIX-011 | 日志搜索 | 搜索日志内容 | 需求18 | P1 |
| FIX-012 | 日志导出 | 导出为文本文件 | 需求18 | P2 |

**任务状态:**
- `pending`: 等待执行
- `running`: 执行中
- `success`: 成功
- `failed`: 失败
- `cancelled`: 已取消

#### 8.3 修复详情查看 (需求19)

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| FIX-013 | 查看修复详情 | 展示详细信息 | 需求19 | P0 |
| FIX-014 | 查看修复分支 | 显示分支名称 | 需求19 | P0 |
| FIX-015 | 查看Commit SHA | 显示提交哈希 | 需求19 | P0 |
| FIX-016 | 查看Commit消息 | 显示提交信息 | 需求19 | P0 |
| FIX-017 | 查看错误信息 | 失败时显示错误 | 需求19 | P0 |
| FIX-018 | 查看执行时间 | 显示开始/结束时间 | 需求19 | P1 |

#### 8.4 忽略配置 (需求20)

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| FIX-019 | 标记为忽略 | 设置是否忽略 | 需求20 | P0 |
| FIX-020 | 配置忽略分类 | 设置忽略原因 | 需求20 | P0 |
| FIX-021 | 查看忽略状态 | 显示是否忽略 | 需求20 | P0 |
| FIX-022 | 取消忽略 | 恢复为不忽略 | 需求20 | P1 |

**忽略分类:**
- `auto-fix`: AI自动修复，不需人工审查
- `manual-review`: 需要人工审查后合并
- `deprecated`: 已废弃，不再处理

#### 8.5 重复修复 (需求22)

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| FIX-023 | 重新修复 | 针对同一建议重复执行 | 需求22 | P0 |
| FIX-024 | 创建新分支 | 每次重复生成新分支 | 需求22 | P0 |
| FIX-025 | 查看修复历史 | 查看同一建议的所有修复 | 需求22 | P1 |

#### 8.6 分支管理 (需求23-24)

| 功能ID | 功能名称 | 功能描述 | 需求 | 优先级 |
|--------|---------|---------|------|--------|
| FIX-026 | 查看修复分支列表 | 展示所有修复分支 | 需求23 | P0 |
| FIX-027 | 删除修复分支 | 删除远程分支 | 需求23 | P0 |
| FIX-028 | 合并修复分支 | 合并到base branch | 需求24 | P0 |
| FIX-029 | 创建MR/PR | 自动创建合并请求 | 需求24 | P0 |
| FIX-030 | 合并方式选择 | merge/squash/rebase | 需求24 | P1 |
| FIX-031 | 合并后删除分支 | 合并成功后自动删除 | 需求24 | P1 |

**分支管理操作:**
- **删除分支**: 调用Git平台API删除远程分支
- **合并分支**: 创建MR/PR → 自动合并 → 可选删除分支

---

## 3. 核心业务流程

### 3.1 Webhook触发Review流程

```
Git平台 (Push/MR事件)
    ↓
Webhook接收 (/webhook)
    ↓
异步任务入队 (Asynq)
    ↓
Worker处理
    ↓
├─ 解析Webhook数据
├─ 获取代码变更 (Diffs)
├─ 过滤文件类型
├─ 获取关联仓库组
├─ 获取LLM配置
├─ 构建提示词
├─ 调用LLM API
├─ 解析结构化结果
├─ 提取修复建议
├─ 发布Review到Git平台
├─ 发送通知
└─ 保存到数据库
```

### 3.2 自动修复流程

```
用户点击"自动修复"
    ↓
创建修复任务 (pending)
    ↓
异步任务入队
    ↓
Worker执行修复
    ↓
├─ 状态 → running
├─ 克隆仓库到本地
├─ 创建修复分支
├─ 执行Snow-CLI (实时记录日志)
├─ 提交代码
├─ 推送到远程
├─ 状态 → success/failed
└─ 保存修复记录
    ↓
用户查看修复结果
    ↓
选择操作:
├─ 合并分支
├─ 删除分支
├─ 重新修复
└─ 标记忽略
```

---

## 4. 功能优先级说明

| 优先级 | 说明 | 功能数量 |
|--------|------|---------|
| **P0** | 核心功能，第一版必须实现 | ~80% |
| **P1** | 重要功能，第二版实现 | ~15% |
| **P2** | 优化功能，后续迭代 | ~5% |

---

## 5. 功能统计

| 模块 | 功能数量 | 核心功能 | 优先级分布 |
|------|---------|---------|-----------|
| 认证与权限 | 5 | 3 | P0:3, P1:2 |
| Git平台管理 | 7 | 6 | P0:6, P1:1 |
| 代码仓库管理 | 14 | 10 | P0:10, P1:4 |
| 仓库组管理 | 18 | 12 | P0:12, P1:5, P2:1 |
| LLM配置管理 | 13 | 10 | P0:10, P1:3 |
| 通知渠道管理 | 11 | 6 | P0:6, P1:4, P2:1 |
| Review记录管理 | 19 | 13 | P0:13, P1:6 |
| 自动修复管理 | 31 | 23 | P0:23, P1:7, P2:1 |
| **总计** | **118** | **83** | **P0:83, P1:32, P2:3** |

---

**下一步**: 页面清单与路由设计
