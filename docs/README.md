# AI 代码审查系统 - 技术设计文档

## 📚 文档索引

本文档集合包含 AI 代码审查系统的完整技术设计，基于**Go 后端 + React 前端**的全新架构。

---

## 📖 文档清单

### 1. [技术栈选型](./01-tech-stack.md) ✅

**关键内容:**

- Go 1.21 + Gin + GORM + Asynq
- React 18 + Ant Design 5 + TypeScript 5
- SQLite/MySQL 双数据库支持
- Redis 任务队列
- 完整的依赖清单

**阅读时长:** 15 分钟

---

### 2. [项目目录结构](./02-project-structure.md) ✅

**关键内容:**

- Go 标准项目布局 (cmd, internal, pkg)
- React 项目结构 (src, components, pages)
- 分层架构设计 (Handler - Service - Repository - Model)
- 命名规范与开发工作流

**阅读时长:** 20 分钟

---

### 3. [数据模型设计](./03-database-design.md) ✅

**关键内容:**

- 15 张数据表设计 (GORM 模型)
- 支持 SQLite 和 MySQL 双驱动
- 完整的 SQL 迁移文件
- 数据库关系图 (ERD)
- 涵盖所有 25 项需求的字段设计

**核心表格:**

- users (用户)
- git_platform_configs (Git 平台)
- repositories (代码仓库)
- repository_groups (仓库组)
- llm_providers, llm_models (LLM 配置)
- notification_channels (通知渠道)
- review_results, fix_suggestions (Review 结果)
- auto_fix_tasks, auto_fix_logs (自动修复)
- fix_branch_management (分支管理)
- system_configs (系统配置)

**阅读时长:** 30 分钟

---

### 4. [功能清单](./04-feature-list.md) ✅

**关键内容:**

- 8 大功能模块拆解
- 118 个功能点详细说明
- 优先级划分 (P0/P1/P2)
- 核心业务流程图

**功能模块:**

1. 认证与权限管理 (5 项)
2. Git 平台管理 (7 项) - 需求 1-3
3. 代码仓库管理 (14 项) - 需求 2-3
4. 仓库组管理 (18 项) - 需求 4-6, 13
5. LLM 配置管理 (13 项) - 需求 9-12
6. 通知渠道管理 (11 项) - 需求 7-8, 21
7. Review 记录管理 (19 项) - 需求 14-15
8. 自动修复管理 (31 项) - 需求 16-25

**阅读时长:** 40 分钟

---

### 5. [页面设计与路由](./05-page-design.md) ✅

**关键内容:**

- 23 个页面详细设计
- React Router 路由配置
- 页面布局示意图 (ASCII Art)
- Ant Design Pro 组件使用
- 自定义组件清单

**核心页面:**

- Dashboard (仪表盘)
- 平台管理 (列表、表单)
- 仓库管理 (列表、导入、Webhook 配置)
- 仓库组管理 (列表、表单、提示词编辑)
- LLM 配置 (供应商、模型管理)
- 通知渠道管理
- Review 记录 (列表、详情)
- 自动修复 (任务列表、详情、分支管理)

**阅读时长:** 35 分钟

---

### 6. [页面交互逻辑](./06-interaction-design.md) ⏭️

**关键内容:**

- 状态管理方案 (Zustand)
- 数据流设计
- 用户操作流程
- WebSocket 实时通信
- 表单验证规则

**阅读时长:** 25 分钟

---

### 7. [API 接口设计](./07-api-design.md) ✅

**关键内容:**

- RESTful API 规范
- 80+ API 接口定义
- 请求/响应格式
- 认证与鉴权
- WebSocket 接口
- 错误码定义

**核心接口:**

- 认证接口 (登录、登出)
- Git 平台管理 (CRUD + 测试连接)
- 仓库管理 (导入、Webhook 配置)
- 仓库组管理 (CRUD + 提示词)
- LLM 管理 (CRUD + 动态获取模型)
- 通知渠道 (CRUD + 测试)
- Review 记录查询
- 自动修复 (创建任务、实时日志、分支管理)
- Webhook 接收
- 系统配置、统计

**阅读时长:** 50 分钟

---

### 8. [核心业务流程](./08-workflow.md) ⏭️

**关键内容:**

- Webhook 触发 Review 流程
- 自动修复完整流程
- 日报生成流程
- 时序图 (Sequence Diagram)

**阅读时长:** 20 分钟

---

### 8. [MVP 分析报告](./08-mvp-analysis.md) ✅

**关键内容:**

- 文档审查结果
- MVP 功能范围定义
- 数据模型优化（15 张表 →7 张表）
- 功能精简（118 项 →35 项）
- 页面优化（23 页 →9 页）
- API 优化（80+接口 →25 接口）

**阅读时长:** 30 分钟

---

### 9. [MVP 功能关系图](./09-mvp-function-diagram.md) ✅

**关键内容:**

- 系统架构图（12 个关系图）
- 核心功能模块关系
- 用户操作流程
- Webhook 触发 Review 流程
- 数据流图
- 技术栈关系图
- 开发阶段甘特图

**阅读时长:** 20 分钟

---

### 10. [MVP 数据模型设计](./10-mvp-database-design.md) ✅

**关键内容:**

- 7 张核心表设计（简化版）
- GORM 模型定义
- SQL 迁移文件（MySQL/SQLite）
- 数据库关系图
- 配置管理方案

**阅读时长:** 25 分钟

---

### 11. [MVP 交互流程](./11-mvp-interaction-flow.md) ✅

**关键内容:**

- 用户初始化配置流程
- 仓库导入与配置流程
- Webhook 触发 Review 流程
- Review 记录查看流程
- 异常处理流程
- 性能优化设计
- 安全性设计

**阅读时长:** 30 分钟

---

### 12. [部署指南](./12-deployment.md) ⏭️

**关键内容:**

- Docker 部署方案
- Kubernetes 部署配置
- 环境变量说明
- 数据库初始化
- 一键部署脚本

**阅读时长:** 15 分钟

---

## 🎯 快速导航

### 📌 MVP 开发推荐阅读路径

**快速了解 MVP:**

1. [MVP 分析报告](./08-mvp-analysis.md) - 了解 MVP 范围和优化思路
2. [MVP 功能关系图](./09-mvp-function-diagram.md) - 可视化理解系统架构
3. [MVP 数据模型](./10-mvp-database-design.md) - 7 张核心表设计

**后端开发:**

1. [技术栈](./01-tech-stack.md) → [MVP 数据模型](./10-mvp-database-design.md) → [MVP 交互流程](./11-mvp-interaction-flow.md) → [API 设计](./07-api-design.md)

**前端开发:**

1. [技术栈](./01-tech-stack.md) → [MVP 交互流程](./11-mvp-interaction-flow.md) → [页面设计](./05-page-design.md) → [API 设计](./07-api-design.md)

---

## 🆕 MVP vs 原设计对比

| 对比项     | 原设计 | MVP 版本 | 精简比例 |
| ---------- | ------ | -------- | -------- |
| 数据库表数 | 15 张  | 7 张     | 53% ↓    |
| 功能点数   | 118 项 | 35 项    | 70% ↓    |
| 页面数量   | 23 页  | 9 页     | 61% ↓    |
| API 接口   | 80+个  | 25 个    | 69% ↓    |
| 开发周期   | 12 周  | 6 周     | 50% ↓    |

**MVP 核心价值:**

- ✅ 聚焦核心场景：GitLab MR 代码审查
- ✅ 快速验证：6 周完成可用版本
- ✅ 降低复杂度：功能精简 70%
- ✅ 保持扩展性：架构支持后续扩展

---

## 🎯 原设计快速导航

### 按角色阅读

**产品经理:**

- 功能清单 (04) → 页面设计 (05) → 业务流程 (08)

**后端开发:**

- 技术栈 (01) → 目录结构 (02) → 数据模型 (03) → API 设计 (07)

**前端开发:**

- 技术栈 (01) → 目录结构 (02) → 页面设计 (05) → 交互逻辑 (06) → API 设计 (07)

**DevOps:**

- 技术栈 (01) → 部署指南 (09)

**项目经理:**

- 功能清单 (04) → 业务流程 (08)

---

## 📊 设计概览

### 核心技术

```
后端：Go 1.21 + Gin + GORM + Asynq
前端：React 18 + Ant Design 5 + TypeScript 5
数据库：SQLite / MySQL (GORM双支持)
缓存/队列：Redis 7
```

### 数据库表格

- **15 张表**: 覆盖所有 25 项需求
- **软删除**: 所有表支持 DeletedAt
- **索引优化**: 关键字段建立索引
- **外键约束**: 保证数据一致性

### 功能统计

- **118 个功能点**
- **83 个 P0 核心功能** (第一版必须实现)
- **32 个 P1 重要功能** (第二版实现)
- **3 个 P2 优化功能** (后续迭代)

### 页面统计

- **23 个页面**
- **80+ API 接口**
- **8 大功能模块**

---

## ✅ 25 项需求覆盖情况

### 认证与仓库管理（1-3）

- [x] 需求 1: 支持页面配置 Git 平台认证，支持多 GitLab 实例
- [x] 需求 2: 支持获取仓库列表并自动配置 Webhook
- [x] 需求 3: 支持配置自定义回调 URL

### 仓库组管理（4-6）

- [x] 需求 4: 支持代码仓库组管理
- [x] 需求 5: 支持为仓库组配置通知渠道
- [x] 需求 6: 支持为仓库组配置专属 LLM 模型

### 通知渠道配置（7-8）

- [x] 需求 7: 支持页面配置通知渠道
- [x] 需求 8: 支持页面测试通知渠道连通性

### LLM 供应商管理（9-12）

- [x] 需求 9: 支持页面配置 LLM 供应商
- [x] 需求 10: 支持页面测试 LLM 连通性
- [x] 需求 11: 每个供应商支持启用多个模型
- [x] 需求 12: 支持动态获取可用模型列表

### 提示词与 Review 结果（13-15）

- [x] 需求 13: 支持为仓库组配置自定义提示词模板
- [x] 需求 14: Review 结果结构化
- [x] 需求 15: 展示修复建议列表

### 自动修复功能（16-21）

- [x] 需求 16: 支持按钮触发自动修复
- [x] 需求 17: 自动修复流程 (clone → branch → fix → commit → push)
- [x] 需求 18: 实时查看修复进度和执行日志
- [x] 需求 19: 查看修复详情
- [x] 需求 20: 配置是否忽略 AI 提交
- [x] 需求 21: 支持配置通知内容

### 修复分支管理（22-25）

- [x] 需求 22: 支持重复修复
- [x] 需求 23: 支持删除修复分支
- [x] 需求 24: 支持合并修复分支

---

## 🚀 下一步行动

### 设计阶段已完成 ✅

现在可以开始编码实现：

1. **初始化项目**

   ```bash
   # 后端
   mkdir -p backend && cd backend
   go mod init github.com/your-org/handsoff

   # 前端
   npm create vite@latest web -- --template react-ts
   ```

2. **数据库初始化**

   ```bash
   # 执行迁移文件
   sqlite3 data/handsoff.db < docs/database_schema.sql
   ```

3. **开发顺序建议**
   - 第一周: 后端基础架构 + 数据模型
   - 第二周: 认证 + Git 平台管理
   - 第三周: 仓库管理 + 仓库组管理
   - 第四周: LLM 配置 + 通知渠道
   - 第五周: Review 记录 + Webhook 处理
   - 第六-八周: 自动修复功能
   - 第九周: 前端集成测试
   - 第十周: 部署与优化

---

## 📝 文档维护

### 更新记录

| 日期       | 版本     | 更新内容                                       | 更新人     |
| ---------- | -------- | ---------------------------------------------- | ---------- |
| 2025-01-30 | v1.0     | 初始技术设计完成                               | Plan Agent |
| 2025-01-30 | v1.1-mvp | MVP 文档审查与优化完成，新增 4 个 MVP 设计文档 | Snow AI    |

### 文档状态

**原设计文档:**

- ✅ 已完成: 01-05, 07
- ⏭️ 待补充: 06, 08, 09, 12

**MVP 文档:**

- ✅ 已完成: 08-mvp-analysis, 09-mvp-function-diagram, 10-mvp-database-design, 11-mvp-interaction-flow

---

## 💡 设计亮点

### 1. 双数据库支持

- GORM 统一抽象
- 配置文件切换
- 兼容 SQLite 和 MySQL

### 2. 结构化 AI 输出

- AI 返回 JSON 格式
- 自动解析为修复建议
- 支持结构化查询

### 3. 实时日志流

- WebSocket 推送
- 分级展示 (info/warning/error)
- 支持历史回放

### 4. 灵活配置

- 仓库组级别配置
- 自定义提示词模板
- 可配置通知内容

### 5. 完整的自动修复闭环

- 一键触发修复
- 实时进度跟踪
- 分支管理
- 可重复修复

---

## 🙏 致谢

本技术设计基于以下原则：

- **简单易用**: React + Ant Design 降低学习成本
- **性能优先**: Go 协程 + Redis 队列
- **易于维护**: 清晰的分层架构
- **易于扩展**: 模块化设计，支持插件

---

**设计完成时间**: 2025 年 1 月 30 日  
**设计工具**: Snow AI Plan Agent  
**设计版本**: v1.0
