# AI代码审查系统 - 技术设计文档

## 📚 文档索引

本文档集合包含AI代码审查系统的完整技术设计，基于**Go后端 + React前端**的全新架构。

---

## 📖 文档清单

### 1. [技术栈选型](./01-tech-stack.md) ✅
**关键内容:**
- Go 1.21 + Gin + GORM + Asynq
- React 18 + Ant Design 5 + TypeScript 5
- SQLite/MySQL 双数据库支持
- Redis任务队列
- 完整的依赖清单

**阅读时长:** 15分钟

---

### 2. [项目目录结构](./02-project-structure.md) ✅
**关键内容:**
- Go标准项目布局 (cmd, internal, pkg)
- React项目结构 (src, components, pages)
- 分层架构设计 (Handler - Service - Repository - Model)
- 命名规范与开发工作流

**阅读时长:** 20分钟

---

### 3. [数据模型设计](./03-database-design.md) ✅
**关键内容:**
- 15张数据表设计 (GORM模型)
- 支持SQLite和MySQL双驱动
- 完整的SQL迁移文件
- 数据库关系图 (ERD)
- 涵盖所有25项需求的字段设计

**核心表格:**
- users (用户)
- git_platform_configs (Git平台)
- repositories (代码仓库)
- repository_groups (仓库组)
- llm_providers, llm_models (LLM配置)
- notification_channels (通知渠道)
- review_results, fix_suggestions (Review结果)
- auto_fix_tasks, auto_fix_logs (自动修复)
- fix_branch_management (分支管理)
- system_configs (系统配置)

**阅读时长:** 30分钟

---

### 4. [功能清单](./04-feature-list.md) ✅
**关键内容:**
- 8大功能模块拆解
- 118个功能点详细说明
- 优先级划分 (P0/P1/P2)
- 核心业务流程图

**功能模块:**
1. 认证与权限管理 (5项)
2. Git平台管理 (7项) - 需求1-3
3. 代码仓库管理 (14项) - 需求2-3
4. 仓库组管理 (18项) - 需求4-6, 13
5. LLM配置管理 (13项) - 需求9-12
6. 通知渠道管理 (11项) - 需求7-8, 21
7. Review记录管理 (19项) - 需求14-15
8. 自动修复管理 (31项) - 需求16-25

**阅读时长:** 40分钟

---

### 5. [页面设计与路由](./05-page-design.md) ✅
**关键内容:**
- 23个页面详细设计
- React Router路由配置
- 页面布局示意图 (ASCII Art)
- Ant Design Pro组件使用
- 自定义组件清单

**核心页面:**
- Dashboard (仪表盘)
- 平台管理 (列表、表单)
- 仓库管理 (列表、导入、Webhook配置)
- 仓库组管理 (列表、表单、提示词编辑)
- LLM配置 (供应商、模型管理)
- 通知渠道管理
- Review记录 (列表、详情)
- 自动修复 (任务列表、详情、分支管理)

**阅读时长:** 35分钟

---

### 6. [页面交互逻辑](./06-interaction-design.md) ⏭️
**关键内容:**
- 状态管理方案 (Zustand)
- 数据流设计
- 用户操作流程
- WebSocket实时通信
- 表单验证规则

**阅读时长:** 25分钟

---

### 7. [API接口设计](./07-api-design.md) ✅
**关键内容:**
- RESTful API规范
- 80+ API接口定义
- 请求/响应格式
- 认证与鉴权
- WebSocket接口
- 错误码定义

**核心接口:**
- 认证接口 (登录、登出)
- Git平台管理 (CRUD + 测试连接)
- 仓库管理 (导入、Webhook配置)
- 仓库组管理 (CRUD + 提示词)
- LLM管理 (CRUD + 动态获取模型)
- 通知渠道 (CRUD + 测试)
- Review记录查询
- 自动修复 (创建任务、实时日志、分支管理)
- Webhook接收
- 系统配置、统计

**阅读时长:** 50分钟

---

### 8. [核心业务流程](./08-workflow.md) ⏭️
**关键内容:**
- Webhook触发Review流程
- 自动修复完整流程
- 日报生成流程
- 时序图 (Sequence Diagram)

**阅读时长:** 20分钟

---

### 9. [部署指南](./09-deployment.md) ⏭️
**关键内容:**
- Docker部署方案
- Kubernetes部署配置
- 环境变量说明
- 数据库初始化
- 一键部署脚本

**阅读时长:** 15分钟

---

## 🎯 快速导航

### 按角色阅读

**产品经理:**
- 功能清单 (04) → 页面设计 (05) → 业务流程 (08)

**后端开发:**
- 技术栈 (01) → 目录结构 (02) → 数据模型 (03) → API设计 (07)

**前端开发:**
- 技术栈 (01) → 目录结构 (02) → 页面设计 (05) → 交互逻辑 (06) → API设计 (07)

**DevOps:**
- 技术栈 (01) → 部署指南 (09)

**项目经理:**
- 功能清单 (04) → 业务流程 (08)

---

## 📊 设计概览

### 核心技术

```
后端：Go 1.21 + Gin + GORM + Asynq
前端：React 18 + Ant Design 5 + TypeScript 5
数据库：SQLite / MySQL (GORM双支持)
缓存/队列：Redis 7
```

### 数据库表格

- **15张表**: 覆盖所有25项需求
- **软删除**: 所有表支持DeletedAt
- **索引优化**: 关键字段建立索引
- **外键约束**: 保证数据一致性

### 功能统计

- **118个功能点**
- **83个P0核心功能** (第一版必须实现)
- **32个P1重要功能** (第二版实现)
- **3个P2优化功能** (后续迭代)

### 页面统计

- **23个页面**
- **80+ API接口**
- **8大功能模块**

---

## ✅ 25项需求覆盖情况

### 认证与仓库管理（1-3）
- [x] 需求1: 支持页面配置Git平台认证，支持多GitLab实例
- [x] 需求2: 支持获取仓库列表并自动配置Webhook
- [x] 需求3: 支持配置自定义回调URL

### 仓库组管理（4-6）
- [x] 需求4: 支持代码仓库组管理
- [x] 需求5: 支持为仓库组配置通知渠道
- [x] 需求6: 支持为仓库组配置专属LLM模型

### 通知渠道配置（7-8）
- [x] 需求7: 支持页面配置通知渠道
- [x] 需求8: 支持页面测试通知渠道连通性

### LLM 供应商管理（9-12）
- [x] 需求9: 支持页面配置LLM供应商
- [x] 需求10: 支持页面测试LLM连通性
- [x] 需求11: 每个供应商支持启用多个模型
- [x] 需求12: 支持动态获取可用模型列表

### 提示词与 Review 结果（13-15）
- [x] 需求13: 支持为仓库组配置自定义提示词模板
- [x] 需求14: Review结果结构化
- [x] 需求15: 展示修复建议列表

### 自动修复功能（16-21）
- [x] 需求16: 支持按钮触发自动修复
- [x] 需求17: 自动修复流程 (clone → branch → fix → commit → push)
- [x] 需求18: 实时查看修复进度和执行日志
- [x] 需求19: 查看修复详情
- [x] 需求20: 配置是否忽略AI提交
- [x] 需求21: 支持配置通知内容

### 修复分支管理（22-25）
- [x] 需求22: 支持重复修复
- [x] 需求23: 支持删除修复分支
- [x] 需求24: 支持合并修复分支

---

## 🚀 下一步行动

### 设计阶段已完成 ✅

现在可以开始编码实现：

1. **初始化项目**
   ```bash
   # 后端
   mkdir -p backend && cd backend
   go mod init github.com/your-org/ai-codereview
   
   # 前端
   npm create vite@latest web -- --template react-ts
   ```

2. **数据库初始化**
   ```bash
   # 执行迁移文件
   sqlite3 data/ai-codereview.db < docs/database_schema.sql
   ```

3. **开发顺序建议**
   - 第一周: 后端基础架构 + 数据模型
   - 第二周: 认证 + Git平台管理
   - 第三周: 仓库管理 + 仓库组管理
   - 第四周: LLM配置 + 通知渠道
   - 第五周: Review记录 + Webhook处理
   - 第六-八周: 自动修复功能
   - 第九周: 前端集成测试
   - 第十周: 部署与优化

---

## 📝 文档维护

### 更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|---------|--------|
| 2025-01-30 | v1.0 | 初始技术设计完成 | Plan Agent |

### 文档状态

- ✅ 已完成: 01-05, 07
- ⏭️ 待补充: 06, 08, 09

---

## 💡 设计亮点

### 1. 双数据库支持
- GORM统一抽象
- 配置文件切换
- 兼容SQLite和MySQL

### 2. 结构化AI输出
- AI返回JSON格式
- 自动解析为修复建议
- 支持结构化查询

### 3. 实时日志流
- WebSocket推送
- 分级展示 (info/warning/error)
- 支持历史回放

### 4. 灵活配置
- 仓库组级别配置
- 自定义提示词模板
- 可配置通知内容

### 5. 完整的自动修复闭环
- 一键触发修复
- 实时进度跟踪
- 分支管理
- 可重复修复

---

## 🙏 致谢

本技术设计基于以下原则：
- **简单易用**: React + Ant Design 降低学习成本
- **性能优先**: Go协程 + Redis队列
- **易于维护**: 清晰的分层架构
- **易于扩展**: 模块化设计，支持插件

---

**设计完成时间**: 2025年1月30日  
**设计工具**: Snow AI Plan Agent  
**设计版本**: v1.0
